#!/usr/bin/env Rscript

'Run lintr on a package.
Usage:
  lintr [--warn_only] <files>...

Options:
  --warn_only  Print lint warnings instead of blocking the commit.
' -> doc

arguments <- docopt::docopt(doc)

if (git2r::in_repository()) {
  git_status <- git2r::status(staged = FALSE)
  if (any(unlist(git_status) == ".lintr")) {
    stop("Unstaged changes to .lintr file. Stage the .lintr file or discard ",
         "the changes to it. ", call. = FALSE)
  }
}

out <- lapply(arguments$files, function(path) {
  lints <- lintr::lint(path)
  if (length(lints) && arguments$warn_only) {
    warning(
      "File ", path, " is not lint free\n",
      call. = FALSE
    )
    print(lints)
  } else if (length(lints)) {
    stop(
      "File ", path, " is not lint free\n",
      "Run lintr::lint('", path, "') to check the lintr output.",
      call. = FALSE
    )
  }
})
